{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{% if is_edit %}Edit{% else %}Add{% endif %} Fixture â€” Nugata FC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Dashboard CSS -->
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}"/>
  {% if club_settings and club_settings.favicon %}
  {% with base=club_settings.favicon.url|cut:".png" %}
  <link rel="icon" type="image/png" sizes="16x16" href="{{ base }}_16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ base }}_32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="{{ base }}_180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="{{ base }}_192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="{{ base }}_512x512.png">
  {% endwith %}
  {% else %}
  <link rel="icon" href="{% static 'default-favicon.ico' %}">
  {% endif %}

  
  <style>
    /* Enhanced styling for the fixture form */
    .fixture-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .fixture-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: var(--primary-light);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    
    .team-selector {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 16px;
      align-items: center;
      margin: 20px 0;
    }
    
    .vs-divider {
      text-align: center;
      color: var(--text-light);
      font-weight: 600;
    }
    
    .team-card {
      background: var(--lighter);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      text-align: center;
      transition: var(--transition);
    }
    
    .team-card:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow);
    }
    
    .team-card select {
      width: 100%;
      border: none;
      background: transparent;
      font-size: 16px;
      font-weight: 500;
      text-align: center;
      color: var(--text);
      outline: none;
      cursor: pointer;
    }
    
    .score-inputs {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 16px;
      align-items: center;
      margin: 20px 0;
    }
    
    .score-input {
      text-align: center;
    }
    
    .score-input input {
      width: 80px;
      height: 80px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 32px;
      font-weight: 700;
      text-align: center;
      color: var(--text);
      transition: var(--transition);
    }
    
    .score-input input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }
    
    .match-details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .datetime-input {
      position: relative;
    }
    
    .datetime-input i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
    }
    
    .datetime-input input {
      padding-left: 40px;
    }
    
    .status-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--light);
      border-radius: var(--radius);
      margin-top: 8px;
      justify-content: center;
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: var(--success);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }
    
    .card {
      background: var(--lighter);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }
    
    .card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
      color: var(--text);
      font-weight: 600;
    }
    
    .card-header i {
      color: var(--primary);
    }

    .form-select {
      width: 100%;
      padding: 8px 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: white;
      appearance: none;
      cursor: pointer;
      transition: border-color 0.3s ease;
    }

    .form-select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 5px var(--primary-light);
    }

    .form-input {
      width: 100%;
      padding: 8px 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: white;
      transition: border-color 0.3s ease;
    }

    .form-input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 5px var(--primary-light);
    }

    .form-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      font-size: 16px;
      font-weight: 600;
      border-radius: var(--radius);
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: background-color 0.3s ease;
    }

    .btn-success {
      background-color: var(--success);
      color: white;
    }

    .btn-success:hover {
      background-color: #28a745cc;
    }

    .btn-secondary {
      background-color: var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background-color: #bbbbbbcc;
    }
  </style>
</head>
<body>
<div class="dashboard-container">
  <!-- Sidebar -->
  {% include "dashboard/partials/sidebar.html" %}

  <!-- Main Content -->
  <main class="main-content">
    <div class="header">
      <h1 class="page-title">{% if is_edit %}Edit{% else %}Add{% endif %} Match</h1>
      <div class="user-menu">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search...">
        </div>
        <div class="user-profile">
          <div class="avatar">
            {{ request.user.first_name|default:"U"|slice:":1" }}{{ request.user.last_name|default:""|slice:":1" }}
          </div>
          <div>{{ request.user.get_full_name|default:request.user.username }}</div>
        </div>
      </div>
    </div>

    <div class="form-container">
      <!-- Upcoming Match Form Errors -->
      {% if match_form.errors or match_form.non_field_errors %}
        <div class="errors" id="upcoming-errors" style="display: {% if form_mode == 'upcoming' %}block{% else %}none{% endif %};">
          <strong>Please fix the errors below:</strong>
          <ul>
            {% for err in match_form.non_field_errors %}<li>{{ err }}</li>{% endfor %}
            {% for field in match_form %}
              {% for err in field.errors %}<li>{{ field.label }}: {{ err }}</li>{% endfor %}
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      <!-- Results Form Errors -->
      {% if result_form.errors or result_form.non_field_errors %}
        <div class="errors" id="results-errors" style="display: {% if form_mode == 'results' %}block{% else %}none{% endif %};">
          <strong>Please fix the errors below:</strong>
          <ul>
            {% for err in result_form.non_field_errors %}<li>{{ err }}</li>{% endfor %}
            {% for field in result_form %}
              {% for err in field.errors %}<li>{{ field.label }}: {{ err }}</li>{% endfor %}
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      <div class="fixture-header">
        <div class="fixture-icon"><i class="fas fa-futbol"></i></div>
        <h2 style="margin:0;">Match Details</h2>
      </div>

      <!-- Only show toggle for add mode, not edit mode -->
      {% if not is_edit %}
      <div class="status-toggle" style="justify-content:center; margin-bottom: 24px;">
        <label class="toggle-switch">
          <input type="radio" name="form_mode" id="toggle_upcoming" value="upcoming"
            {% if form_mode == "upcoming" or not form_mode %}checked{% endif %}>
          <span class="toggle-slider"></span>
        </label>
        <label for="toggle_upcoming" style="margin-right: 24px; font-weight:600; cursor:pointer;">Upcoming Match</label>

        <label class="toggle-switch">
          <input type="radio" name="form_mode" id="toggle_results" value="results"
            {% if form_mode == "results" %}checked{% endif %}>
          <span class="toggle-slider"></span>
        </label>
        <label for="toggle_results" style="font-weight:600; cursor:pointer;">Results</label>
      </div>
      {% endif %}

      <!-- Upcoming Match Form -->
      <form method="post" class="form-content" id="upcoming_form" style="display: {% if form_mode == 'upcoming' or not form_mode or is_edit %}block{% else %}none{% endif %};">
        {% csrf_token %}
        <input type="hidden" name="form_mode" value="upcoming">

        <div class="card">
          <div class="card-header"><i class="fas fa-users"></i> Teams</div>
          <div class="team-selector">
            <div class="team-card">
              <label for="id_home_team">Home Team</label>
              <select name="home_team" id="id_home_team" class="form-select">
                <option value="">Select home team</option>
                {% for team in match_form.fields.home_team.queryset %}
                  <option value="{{ team.id }}" data-stadium="{{ team.stadium }}"
                    {% if match_form.home_team.value and match_form.home_team.value == team.id|stringformat:"s" %}selected{% endif %}>
                    {{ team.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="vs-divider">
              <div style="font-size:12px;">VERSUS</div>
              <div style="font-size:20px; font-weight:bold;">VS</div>
            </div>
            <div class="team-card">
              <label for="id_away_team">Away Team</label>
              {{ match_form.away_team }}
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><i class="fas fa-info-circle"></i> Match Information</div>
          <div class="match-details-grid">
            <div class="form-group">
              <label for="id_date" class="form-label">Date & Time</label>
              <div class="datetime-input"><i class="fas fa-calendar-alt"></i>{{ match_form.date }}</div>
            </div>
            <div class="form-group">
              <label for="id_location" class="form-label">Location</label>
              <div class="datetime-input"><i class="fas fa-map-marker-alt"></i>{{ match_form.location }}</div>
            </div>
            <div class="form-group">
              <label for="id_match_type" class="form-label">Match Type</label>
              {{ match_form.match_type }}
            </div>
            <div class="form-group">
              <label for="id_season" class="form-label">Season</label>
              {{ match_form.season }}
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="form-actions">
          <div class="action-left">
            <a href="{% url 'dashboard:match_manager' %}" class="btn btn-secondary">
              <i class="fas fa-times"></i> Cancel
            </a>
          </div>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-save"></i> {% if is_edit %}Update{% else %}Save{% endif %} Match
          </button>
        </div>
      </form>

      <!-- Results Form (only show in add mode) -->
      {% if not is_edit %}
      <form method="post" class="form-content" id="results_form" style="display: {% if form_mode == 'results' %}block{% else %}none{% endif %};">
        {% csrf_token %}
        <input type="hidden" name="form_mode" value="results">

        <div class="card">
          <div class="card-header"><i class="fas fa-flag-checkered"></i> Select Match</div>
          <div class="form-group">
            <label for="id_match_selector">Select Match</label>
            {{ result_form.match_selector }}
          </div>
          {{ result_form.match_id }}  <!-- Hidden field -->
        </div>

        <div class="card" id="results_match_info" style="display:none;">
          <div class="card-header"><i class="fas fa-info-circle"></i> Match Information</div>
          <div class="match-details-grid">
            <div class="form-group">
              <label>Home Team</label>
              <input type="text" id="result_home_team" class="form-input" readonly>
            </div>
            <div class="form-group">
              <label>Away Team</label>
              <input type="text" id="result_away_team" class="form-input" readonly>
            </div>
            <div class="form-group">
              <label>Date & Time</label>
              <input type="text" id="result_date" class="form-input" readonly>
            </div>
            <div class="form-group">
              <label>Location</label>
              <input type="text" id="result_location" class="form-input" readonly>
            </div>
            <div class="form-group">
              <label>Match Type</label>
              <input type="text" id="result_type" class="form-input" readonly>
            </div>
            <div class="form-group">
              <label>Season</label>
              <input type="text" id="result_season" class="form-input" readonly>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><i class="fas fa-scoreboard"></i> Scores</div>
          <div class="score-inputs">
            <div class="score-input">{{ result_form.home_score }}</div>
            <div class="vs-divider"><div style="font-size:14px;">SCORE</div><div style="font-size:16px;">-</div></div>
            <div class="score-input">{{ result_form.away_score }}</div>
          </div>
        </div>

        <!-- Actions -->
        <div class="form-actions">
          <div class="action-left">
            <a href="{% url 'dashboard:match_manager' %}" class="btn btn-secondary">
              <i class="fas fa-times"></i> Cancel
            </a>
          </div>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-save"></i> Save Result
            </button>
          </div>
        </form>
      {% endif %}
    </div>
  </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const toggleUpcoming = document.getElementById('toggle_upcoming');
  const toggleResults = document.getElementById('toggle_results');
  const upcomingForm = document.getElementById('upcoming_form');
  const resultsForm = document.getElementById('results_form');
  const upcomingErrors = document.getElementById('upcoming-errors');
  const resultsErrors = document.getElementById('results-errors');
  const matchSelect = document.getElementById('id_match_selector'); // Changed to match_selector
  const infoSection = document.getElementById('results_match_info');
  const isEditMode = {% if is_edit %}true{% else %}false{% endif %};

  function switchFormSection() {
    if(!isEditMode) {
      if(toggleUpcoming && toggleUpcoming.checked){
        if (upcomingForm) upcomingForm.style.display = 'block';
        if (resultsForm) resultsForm.style.display = 'none';
        if (upcomingErrors) upcomingErrors.style.display = 'block';
        if (resultsErrors) resultsErrors.style.display = 'none';
      } else if(toggleResults && toggleResults.checked){
        if (upcomingForm) upcomingForm.style.display = 'none';
        if (resultsForm) resultsForm.style.display = 'block';
        if (upcomingErrors) upcomingErrors.style.display = 'none';
        if (resultsErrors) resultsErrors.style.display = 'block';
      }
    }
  }

  if (toggleUpcoming && toggleResults) {
    toggleUpcoming.addEventListener('change', switchFormSection);
    toggleResults.addEventListener('change', switchFormSection);
  }

  // Populate match info when a match is selected
  if (matchSelect) {
    matchSelect.addEventListener('change', function() {
      const matchId = this.value;
      const matchIdInput = document.getElementById('id_match_id');
      
      if (matchIdInput) {
        matchIdInput.value = matchId; // Update the hidden field
      }
      
      if (!matchId) {
        if (infoSection) infoSection.style.display = 'none';
        return;
      }

      fetch(`/dashboard/match-info/${matchId}/`)
        .then(res => res.json())
        .then(data => {
          document.getElementById('result_home_team').value = data.home_team;
          document.getElementById('result_away_team').value = data.away_team;
          document.getElementById('result_date').value = data.date;
          document.getElementById('result_location').value = data.location;
          document.getElementById('result_type').value = data.match_type;
          document.getElementById('result_season').value = data.season;

          if (infoSection) infoSection.style.display = 'block';
        })
        .catch(error => {
          console.error('Error fetching match info:', error);
        });
    });
  }

  // Auto-fill location for upcoming match when home team selected
  const homeTeamSelect = document.getElementById('id_home_team');
  const locationInput = document.getElementById('id_location');
  if(homeTeamSelect && locationInput){
    homeTeamSelect.addEventListener('change', function(){
      const selectedOption = homeTeamSelect.options[homeTeamSelect.selectedIndex];
      const stadium = selectedOption.getAttribute('data-stadium');
      if(stadium) locationInput.value = stadium;
    });
  }

  // Set initial section
  if (!isEditMode) {
    switchFormSection();
    
    // If we're in results mode and there's a selected match, trigger the change event
    if (matchSelect && matchSelect.value && toggleResults && toggleResults.checked) {
      matchSelect.dispatchEvent(new Event('change'));
    }
  }
});
</script>

</body>
</html>


</html>